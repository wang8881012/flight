<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>票種選擇</title>

    <!-- 日期樣式與 Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" rel="stylesheet" />

    <style>
        .hidden {
            display: none;
        }

        .trip-btn {
            padding: 8px 16px;
            margin-right: 8px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            font-size: 16px;
            outline: none;
            border-bottom: 2px solid transparent;
        }

        .trip-btn.active {
            border-bottom: 2px solid #2B3B52;
            font-weight: bold;
            color: #2B3B52;
        }

        .trip-btn:focus {
            outline: none;
        }
    </style>
</head>

<body class="container py-4">
    <div>
        <button type="button" id="btnRound" class="trip-btn active">來回票</button>
        <button type="button" id="btnOneWay" class="trip-btn">單程</button>
    </div>
    <hr>

    <!-- 來回票 -->
    <div id="roundTripSelects">
        <h3>來回票</h3>
        <label>去程 出發：</label>
        <select id="departureCityRound1"></select>
        <label>目的：</label>
        <select id="arrivalCityRound1"></select><br />
        <label>回程 出發：</label>
        <select id="departureCityRound2"></select>
        <label>目的：</label>
        <select id="arrivalCityRound2"></select>
    </div>

    <!-- 單程 -->
    <div id="oneWaySelects" class="hidden">
        <h3>單程</h3>
        <label>出發：</label>
        <select id="departureCityOneWay"></select>
        <label>目的：</label>
        <select id="arrivalCityOneWay"></select>
    </div>

    <!-- 日期選擇 -->
    <div class="my-3">
        <div class="row align-items-center">
            <div class="col-6">
                <label for="dateRangePicker" class="form-label">選擇日期區間</label>
                <input type="text" id="dateRangePicker" class="form-control" readonly />
            </div>
        </div>
    </div>

    <!-- 選擇人數 -->
    <div>
        <button id="btnMinus">-</button>
        <span id="passengerCount">1</span>
        <button id="btnPlus">+</button>
    </div>


    <button id="nextPageBtn" class="btn btn-primary mt-3">下一頁</button>

    <!-- JS 套件 -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let selectedStartDate = null;
        let selectedEndDate = null;
        let tripType = 'round';

        function initDatePicker() {
            const $datePicker = $('#dateRangePicker');

            $datePicker.off(); // 移除舊事件
            $datePicker.val(''); // 清空顯示
            selectedStartDate = null;
            selectedEndDate = null;

            if (tripType === 'round') {
                $datePicker.daterangepicker({
                    opens: 'right',
                    locale: {
                        format: 'YYYY-MM-DD',
                        separator: ' 至 ',
                        applyLabel: '套用',
                        cancelLabel: '取消',
                        fromLabel: '從',
                        toLabel: '到',
                        daysOfWeek: ['日', '一', '二', '三', '四', '五', '六'],
                        monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
                        firstDay: 1
                    },
                    autoUpdateInput: false
                });

                $datePicker.on('apply.daterangepicker', function (ev, picker) {
                    selectedStartDate = picker.startDate.format('YYYY-MM-DD');
                    selectedEndDate = picker.endDate.format('YYYY-MM-DD');
                    $(this).val(`${selectedStartDate} 至 ${selectedEndDate}`);
                });

            } else if (tripType === 'oneway') {
                $datePicker.daterangepicker({
                    singleDatePicker: true,
                    showDropdowns: true,
                    locale: {
                        format: 'YYYY-MM-DD',
                        applyLabel: '套用',
                        cancelLabel: '取消',
                        daysOfWeek: ['日', '一', '二', '三', '四', '五', '六'],
                        monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
                        firstDay: 1
                    },
                    autoUpdateInput: false
                });

                $datePicker.on('apply.daterangepicker', function (ev, picker) {
                    selectedStartDate = picker.startDate.format('YYYY-MM-DD');
                    selectedEndDate = null;
                    $(this).val(selectedStartDate);
                });
            }

            $datePicker.on('cancel.daterangepicker', function () {
                $(this).val('');
                selectedStartDate = null;
                selectedEndDate = null;
            });
        }


        const btnRound = document.getElementById('btnRound');
        const btnOneWay = document.getElementById('btnOneWay');
        const roundTripDiv = document.getElementById('roundTripSelects');
        const oneWayDiv = document.getElementById('oneWaySelects');

        function toggleSelects() {
            if (tripType === 'round') {
                roundTripDiv.classList.remove('hidden');
                oneWayDiv.classList.add('hidden');
                btnRound.classList.add('active');
                btnOneWay.classList.remove('active');
            } else {
                roundTripDiv.classList.add('hidden');
                oneWayDiv.classList.remove('hidden');
                btnRound.classList.remove('active');
                btnOneWay.classList.add('active');
            }
        }

        btnRound.addEventListener('click', () => {
            tripType = 'round';
            toggleSelects();
            initDatePicker(); // 重新初始化日期區間選擇器
        });

        btnOneWay.addEventListener('click', () => {
            tripType = 'oneway';
            toggleSelects();
            initDatePicker(); // 換成單日選擇器
        });

        toggleSelects();
        initDatePicker();

        function setOptions(selectElem, options) {
            selectElem.innerHTML = '';
            [...new Set(options)].forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                selectElem.appendChild(option);
            });
        }

        fetch('../api/flights/list.php')
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    const flights = data.flights;

                    const fromAirports = flights.map(f => f.from_airport_name);
                    const toAirports = flights.map(f => f.to_airport_name);

                    setOptions(document.getElementById('departureCityRound1'), fromAirports);
                    setOptions(document.getElementById('arrivalCityRound1'), toAirports);
                    setOptions(document.getElementById('departureCityRound2'), toAirports);
                    setOptions(document.getElementById('arrivalCityRound2'), fromAirports);
                    setOptions(document.getElementById('departureCityOneWay'), fromAirports);
                    setOptions(document.getElementById('arrivalCityOneWay'), toAirports);
                } else {
                    alert('載入航班資料失敗');
                }
            })
            .catch(err => {
                console.error(err);
                alert('載入資料時發生錯誤');
            });

        document.getElementById('nextPageBtn').addEventListener('click', () => {
            let url;
            const baseParams = {};

            if (selectedStartDate) {
                baseParams.startDate = selectedStartDate;
            }
            if (selectedEndDate) {
                baseParams.endDate = selectedEndDate;
            }

            if (tripType === 'round') {
                const d1 = document.getElementById('departureCityRound1').value;
                const a1 = document.getElementById('arrivalCityRound1').value;
                const d2 = document.getElementById('departureCityRound2').value;
                const a2 = document.getElementById('arrivalCityRound2').value;

                if (d1 === a1 || d2 === a2) {
                    alert('出發地與目的地不可相同');
                    return;
                }

                const params = new URLSearchParams({
                    ...baseParams,
                    tripType: 'round',
                    departure1: d1,
                    arrival1: a1,
                    departure2: d2,
                    arrival2: a2
                });

                url = `search.html?${params.toString()}`;
            } else {
                const d = document.getElementById('departureCityOneWay').value;
                const a = document.getElementById('arrivalCityOneWay').value;

                if (d === a) {
                    alert('出發地與目的地不可相同');
                    return;
                }

                const params = new URLSearchParams({
                    ...baseParams,
                    tripType: 'oneway',
                    departure: d,
                    arrival: a
                });

                url = `search.html?${params.toString()}`;
            }

            window.location.href = url;
        });

        // 選擇人數
        let passengerCount = parseInt(localStorage.getItem('passengerCount')) || 1;

        const passengerCountSpan = document.getElementById('passengerCount');
        const btnMinus = document.getElementById('btnMinus');
        const btnPlus = document.getElementById('btnPlus');

        function updatePassengerDisplay() {
            passengerCountSpan.textContent = passengerCount;
            localStorage.setItem('passengerCount', passengerCount);
        }

        btnMinus.addEventListener('click', () => {
            if (passengerCount > 1) {
                passengerCount--;
                updatePassengerDisplay();
            }
        });

        btnPlus.addEventListener('click', () => {
            passengerCount++;
            updatePassengerDisplay();
        });

        updatePassengerDisplay();// 初始化顯示人數


    </script>
</body>

</html>